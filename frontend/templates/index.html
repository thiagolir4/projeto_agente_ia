<!DOCTYPE html>
<html lang="pt-br">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Gerenciador MongoDB</title>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
    />
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='style.css') }}"
    />

    <style>
      /* Estilos para tabelas HTML */
      .message-content table {
        width: 100% !important;
        margin: 10px 0 !important;
        border-collapse: collapse !important;
        background-color: white !important;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1) !important;
        border-radius: 8px !important;
        overflow: hidden !important;
      }

      .message-content th {
        background-color: #f8f9fa !important;
        padding: 12px 15px !important;
        text-align: left !important;
        font-weight: bold !important;
        color: #495057 !important;
        border-bottom: 2px solid #dee2e6 !important;
      }

      .message-content td {
        padding: 10px 15px !important;
        border-bottom: 1px solid #dee2e6 !important;
        color: #495057 !important;
      }

      .message-content tr:nth-child(even) {
        background-color: #f8f9fa !important;
      }

      .message-content tr:nth-child(odd) {
        background-color: white !important;
      }

      .message-content h3 {
        color: #333 !important;
        margin-bottom: 15px !important;
        text-align: center !important;
      }

      .message-content p {
        text-align: center !important;
        margin-top: 10px !important;
        color: #6c757d !important;
        font-size: 14px !important;
      }
    </style>
  </head>
  <body class="p-4 bg-prim√°rio.bg-gradiente">
    <h1 class="text-center mb-4">Grupo Oscar</h1>

    <form
      method="post"
      action="{{ url_for('importar') }}"
      enctype="multipart/form-data"
      class="mb-3 border rounded p-3 bg-white text-dark"
    >
      <h2>Importa√ß√£o de CSV</h2>
      <label class="form-label"
        >Insira um link ou escolha um arquivo CSV:</label
      >
      <div class="row">
        <div class="col">
          <input
            type="text"
            name="caminho"
            placeholder="Link do Google Sheets"
            class="form-control mb-2"
          />
        </div>
        <div class="col">
          <input
            type="file"
            name="arquivo"
            accept=".csv"
            class="form-control mb-2"
          />
        </div>
      </div>
      <button class="btn btn-success">Importar</button>
    </form>

    <ul class="list-group mb-3 border rounded p-3 bg-white text-dark">
      <h2>Cole√ß√µes existentes</h2>
      {% for col in colecoes %}
      <li
        class="list-group-item d-flex justify-content-between align-items-center"
      >
        <a href="{{ url_for('ver_colecao', nome=col) }}">{{ col }}</a>
        <form
          method="post"
          action="{{ url_for('excluir_colecao', nome=col) }}"
          onsubmit="return confirm('Tem certeza que deseja excluir {{ col }}?')"
        >
          <button class="btn btn-danger btn-sm">Excluir</button>
        </form>
      </li>
      {% endfor %}
    </ul>

    <div class="mb-3 border rounded p-3 bg-white text-dark">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h2>üí¨ Chat com Agente IA</h2>
        <button id="limpar-historico" class="btn btn-outline-danger btn-sm">
          üóëÔ∏è Limpar Hist√≥rico
        </button>
      </div>
      <div
        id="chat-container"
        style="
          height: 400px;
          overflow-y: auto;
          border: 1px solid #ddd;
          padding: 10px;
          margin-bottom: 10px;
          background-color: #f8f9fa;
        "
      >
        <div id="chat-messages">
          <div class="alert alert-info">
            <strong>ü§ñ Agente:</strong> Ol√°! Sou seu assistente de IA. Posso
            ajud√°-lo a analisar os dados importados no MongoDB. Fa√ßa perguntas
            sobre as cole√ß√µes, dados ou qualquer an√°lise que precisar!
          </div>
        </div>
      </div>
      <form id="chat-form" class="d-flex">
        <input
          type="text"
          id="chat-input"
          class="form-control me-2"
          placeholder="Digite sua pergunta aqui..."
          required
        />
        <button type="submit" class="btn btn-primary">Enviar</button>
      </form>
    </div>

    {% with messages = get_flashed_messages() %} {% if messages %}
    <div class="mt-3">
      {% for msg in messages %}
      <div class="alert alert-info">{{ msg }}</div>
      {% endfor %}
    </div>
    {% endif %} {% endwith %}

    <script>
      // Carregar hist√≥rico quando a p√°gina carrega
      document.addEventListener("DOMContentLoaded", async function () {
        await carregarHistorico();
      });

      async function carregarHistorico() {
        try {
          console.log("üîÑ Carregando hist√≥rico...");

          // Tentar carregar estat√≠sticas primeiro
          const response = await fetch("/historico/estatisticas");
          if (!response.ok) {
            console.log("‚ùå Erro ao carregar estat√≠sticas");
            return;
          }

          const stats = await response.json();
          console.log("üìä Estat√≠sticas:", stats);

          if (stats.total_mensagens > 0) {
            // Se h√° mensagens, carregar a √∫ltima sess√£o
            const sessoesResponse = await fetch("/historico/sessoes");
            if (!sessoesResponse.ok) {
              console.log("‚ùå Erro ao carregar sess√µes");
              return;
            }

            const sessoes = await sessoesResponse.json();
            console.log("üìã Sess√µes encontradas:", sessoes);

            if (sessoes.length > 0) {
              // Carregar mensagens da √∫ltima sess√£o
              const ultimaSessao = sessoes[0]._id;
              console.log("üîÑ Carregando sess√£o:", ultimaSessao);
              await carregarMensagensSessao(ultimaSessao);
            }
          } else {
            console.log("üìù Nenhuma mensagem encontrada no hist√≥rico");
          }
        } catch (error) {
          console.log("‚ùå Erro ao carregar hist√≥rico:", error);
        }
      }

      async function carregarMensagensSessao(sessaoId) {
        try {
          console.log("üì® Carregando mensagens da sess√£o:", sessaoId);

          // Carregar mensagens da sess√£o via API
          const response = await fetch(`/historico/sessao/${sessaoId}`);
          if (!response.ok) {
            console.log("‚ùå Erro ao carregar mensagens da sess√£o");
            return;
          }

          const mensagens = await response.json();
          console.log("üì® Mensagens carregadas:", mensagens.length);

          if (mensagens.length > 0) {
            // Limpar mensagens atuais
            const messagesContainer = document.getElementById("chat-messages");
            messagesContainer.innerHTML = "";

            // Adicionar mensagens ao chat
            mensagens.forEach((msg) => {
              if (msg.tipo === "usuario") {
                addMessage("Voc√™", msg.conteudo, "user");
              } else if (msg.tipo === "agente") {
                addMessage("ü§ñ Agente", msg.conteudo, "agent");
              }
            });

            // Scroll para baixo
            const chatContainer = document.getElementById("chat-container");
            chatContainer.scrollTop = chatContainer.scrollHeight;

            console.log("‚úÖ Hist√≥rico carregado com sucesso!");
          } else {
            console.log("üìù Nenhuma mensagem encontrada na sess√£o");
          }
        } catch (error) {
          console.log("‚ùå Erro ao carregar mensagens da sess√£o:", error);
        }
      }

      document
        .getElementById("chat-form")
        .addEventListener("submit", async function (e) {
          e.preventDefault();

          const input = document.getElementById("chat-input");
          const message = input.value.trim();

          if (!message) return;

          // Adicionar mensagem do usu√°rio
          addMessage("Voc√™", message, "user");
          input.value = "";

          // Mostrar indicador de carregamento
          const loadingId = addMessage(
            "ü§ñ Agente",
            "Processando...",
            "agent",
            true
          );

          try {
            const response = await fetch("/chat", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({ message: message }),
            });

            const data = await response.json();

            // Remover indicador de carregamento
            removeMessage(loadingId);

            // Adicionar resposta do agente
            addMessage("ü§ñ Agente", data.response, "agent");
          } catch (error) {
            removeMessage(loadingId);
            addMessage(
              "‚ùå Erro",
              "Erro ao conectar com o agente: " + error.message,
              "error"
            );
          }
        });

      function addMessage(sender, text, type, isLoading = false) {
        const messagesContainer = document.getElementById("chat-messages");
        const messageId =
          "msg_" + Date.now() + "_" + Math.random().toString(36).substr(2, 9);

        const messageDiv = document.createElement("div");
        messageDiv.id = messageId;
        messageDiv.className = `mb-2 ${
          type === "user" ? "text-end" : "text-start"
        }`;

        const alertClass =
          type === "user"
            ? "alert-primary"
            : type === "error"
            ? "alert-danger"
            : "alert-success";

        messageDiv.innerHTML = `
        <div class="alert ${alertClass} d-inline-block" style="max-width: 80%;">
          <strong>${sender}:</strong> <span class="message-content">${text}</span>
          ${
            isLoading
              ? '<div class="spinner-border spinner-border-sm ms-2" role="status"></div>'
              : ""
          }
        </div>
      `;

        messagesContainer.appendChild(messageDiv);

        // Scroll para baixo
        const chatContainer = document.getElementById("chat-container");
        chatContainer.scrollTop = chatContainer.scrollHeight;

        return messageId;
      }

      function removeMessage(messageId) {
        const message = document.getElementById(messageId);
        if (message) {
          message.remove();
        }
      }

      // Bot√£o para limpar hist√≥rico
      document
        .getElementById("limpar-historico")
        .addEventListener("click", async function () {
          if (
            confirm(
              "Tem certeza que deseja limpar todo o hist√≥rico de conversas?"
            )
          ) {
            try {
              const response = await fetch("/historico/limpar", {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                },
              });

              const data = await response.json();

              if (data.success) {
                // Limpar a interface
                const messagesContainer =
                  document.getElementById("chat-messages");
                messagesContainer.innerHTML = `
                <div class="alert alert-info">
                  <strong>ü§ñ Agente:</strong> Ol√°! Sou seu assistente de IA. Posso
                  ajud√°-lo a analisar os dados importados no MongoDB. Fa√ßa perguntas
                  sobre as cole√ß√µes, dados ou qualquer an√°lise que precisar!
                </div>
              `;

                // Mostrar mensagem de sucesso
                addMessage(
                  "‚úÖ Sistema",
                  "Hist√≥rico limpo com sucesso!",
                  "success"
                );
              } else {
                addMessage(
                  "‚ùå Erro",
                  "Erro ao limpar hist√≥rico: " + data.error,
                  "error"
                );
              }
            } catch (error) {
              addMessage(
                "‚ùå Erro",
                "Erro ao conectar: " + error.message,
                "error"
              );
            }
          }
        });
    </script>
  </body>
</html>
